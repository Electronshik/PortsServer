<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Serial Port Communicator</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous"> -->
    <link href="/html/bootstrap-5.3.0-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  </head>
  <body>
    <div class="container py-5">
      <h3 class="h3">Serial Port Communicator</h3>

      <div class="row"  id="config-buttons">
        <p>
          <div class="col-sm-2">
            <p>Active configuration:</p>
          </div>
          <div class="col-sm-3">
            <select class="form-select" id="select_config" aria-label="Default select example">
              {% for config in configs %}<option value="{{ config }}" {% if config == config_selected %} selected {% endif %} >{{ config }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-sm-4">
            <button type="button" class="btn btn-success" id="add_config">Add configuration</button>
            <button type="button" class="btn btn-success" id="delete_config">Delete configuration</button>
          </div>
        </p>
      </div>

      <div class="row py-2" id="config_new_name_wrapper"></div>

      <div class="row py-2">
        <div class="col-sm-2"><label for="config_speed">Speed</label></div>
        <div class="col-sm-1"><label for="config_databits">Data Bits</label></div>
        <div class="col-sm-1"><label for="config_parity">Parity</label></div>
        <div class="col-sm-1"><label for="config_stopbits">Stop Bits</label></div>
        <div class="col-sm-1"><label for="config_flowcontrol">Flow Ctrl</label></div>
      </div>

      <div class="row">
        <div class="col-sm-2">
          <select class="form-select" id="config_speed" disabled>
            {% for speed in all_port_speed %}<option value="{{ speed }}" {% if speed == port_speed %} selected {% endif %} >{{ speed }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_databits" disabled>
            {% for databits in all_port_databits %}<option value="{{ databits }}" {% if databits == port_databits %} selected {% endif %} >{{ databits }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_parity" disabled>
            {% for parity in all_port_parity %}<option value="{{ parity }}" {% if parity == port_parity %} selected {% endif %} >{{ parity }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_stopbits" disabled>
            {% for stopbits in all_port_stopbits %}<option value="{{ stopbits }}" {% if stopbits == port_stopbits %} selected {% endif %} >{{ stopbits }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_flowcontrol" disabled>
            {% for flowcontrol in all_port_flowcontrol %}<option value="{{ flowcontrol }}" {% if flowcontrol == port_flowcontrol %} selected {% endif %} >{{ flowcontrol }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-3">
          <button type="button" class="btn btn-success" id="edit_config_params">Edit Config</button>
          <button type="button" class="btn btn-success" id="save_config_params" disabled>Save</button>
          <button type="button" class="btn btn-success" id="cancel_config_params" disabled>Cancel</button>
         </div>
      </div>

      <div id="port-wrapper">
        <div class="row py-5">
          <div class="col-sm-2">
            <p>Available Ports:</p>
          </div>
          <div class="col-sm-3">
            <select class="form-select" id="select_ports" :disabled="portIsOpened" aria-label="Default select example">
              <option v-for="port in ports" :value="port">{{ port }}</option>
            </select>
          </div>
          <div class="col-sm-5">
            <button type="button" class="btn btn-success" id="port_scan" v-on:click="scanPorts" :disabled="portIsOpened">Rescan Ports</button>
            <button type="button" class="btn btn-primary" id="port_open" v-on:click="openPort" :disabled="portIsOpened">Port Open</button>
            <button type="button" class="btn btn-primary" id="port_close" v-on:click="closePort" :disabled="portIsClosed">Port Close</button>
          </div>
        </div>

        <div class="row py-5">
          <config-command v-for="command in commands" v-bind:cmd="command.cmd" v-bind:name="command.name"></config-command>
        </div>
        </div class="row py-2">
          <p id="received_data"></p>
        </div>
      </div>

    </div> <!-- container -->

    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script> -->
    <script src="/html/bootstrap-5.3.0-dist/js/bootstrap.bundle.min.js"></script>
    <script>

      let recvTimerId;
      function enableReceiveTimer(enable = false) {
        if (enable)
        {
          recvTimerId = setInterval(() => {
            fetch('/api/readfromport', {
              method: 'POST',
              body: 'port=' + document.getElementById('select_ports').value
            })
            .then((response) => { return response.json() })
            .then((data) => {
              if (data.result == ErrorCodeOk) {
                document.getElementById('received_data').innerHTML += data.received;
                console.log('Readed from port: ' + data.received);
              }
            })
            .catch((error) => console.log(error));
          }, 1000)
        }
        else
        {
          clearInterval(recvTimerId);
        }
      }

      Vue.component('config-command', {
        props: ['cmd', 'name'],
        computed: {
          disabled: function() {
            return !this.$parent.port_is_opened;
          }
        },
        methods: {
          sendEvent: function() {
            this.$parent.sendCommand(this.cmd);
          }
        },
        template: '<div class="row">  \
                    <div class="col-sm-2">  \
                      <button type="button" class="btn btn-success"	v-on:click="sendEvent" :disabled="disabled">{{ name }}</button>  \
                    </div>  \
                    <div class="col-sm-2"">  \
                    <p>{{ cmd }}</p></div>  \
                  </div>'
      })

      var Ports = new Vue({
        el: '#port-wrapper',
        data: {
          port_is_opened : false,
          commands: [
            //{{ commands_array }}
          ],
          ports : ''
        },
        computed: {
          portIsOpened: function() {
            return this.port_is_opened;
          },
          portIsClosed: function() {
            return !this.port_is_opened;
          }
        },
        methods: {
          scanPorts: function () {
            fetch('/api/getportslist').then((response) => { return response.json() })
            .then((data) => this.ports = data.ports)
            .catch((error) => console.log(error));
          },
          openPort: function () {
            fetch('/api/openport', {
              method: 'POST',
              body: 'port=' + this.$el.querySelector("#select_ports").value + '&' + getConfigPostParams()
            })
            .then((response) => { return response.json() })
            .then((data) => {
              console.log(data);
              if (data.result == ErrorCodeOk) {
                enableReceiveTimer(true);
                this.port_is_opened = true;
              }
            })
            .catch((error) => console.log(error));
          },
          closePort: function () {
            fetch('/api/closeport', {
              method: 'POST',
              body: 'port=' + this.$el.querySelector("#select_ports").value
            })
            .then((response) => { return response.json() })
            .then((data) => {
              enableReceiveTimer(false);
              this.port_is_opened = false;
            })
            .catch((error) => console.log(error));
          },
          sendCommand: function (command) {
            fetch('/api/sendtoport', {
              method: 'POST',
              body: 'port=' + document.getElementById('select_ports').value + '&cmd=' + command
            })
            .then((response) => { return response.json() })
            .then((data) => {
              if (data.result == ErrorCodeError)
              {
                enableReceiveTimer(false);
              }
              console.log('Sended to port: ' + command);
            })
            .catch((error) => console.log(error));
          }
        },
        beforeMount() {
          this.scanPorts()
        }
      })

      var ErrorCodeOk = '{{ error_code_ok }}';
      var ErrorCodeError = '{{ error_code_error }}';

      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          let date = new Date();
          date.setTime(date.getTime() + (days*24*60*60*1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
      }

      var params_array = ['config_speed', 'config_databits', 'config_parity', 'config_stopbits', 'config_flowcontrol'];

      function getConfigPostParams()
      {
        postStr = '';
        for(param_id of params_array)
        {
          postStr += param_id + '=' + encodeURIComponent(document.getElementById(param_id).value);
          if(param_id != params_array.slice(-1))
            postStr += '&';
        }
        return postStr;
      }

      var new_config_process = false;

      function setParamsActive(active, config_name = 'NewName') {
        for(param_id of params_array)
          document.getElementById(param_id).disabled = !active;

        document.getElementById('select_config').disabled = active;
        document.getElementById('save_config_params').disabled = !active;
        document.getElementById('cancel_config_params').disabled = !active;

        let config_new_name_wrapper = document.getElementById('config_new_name_wrapper');
        if(active)
        {
          config_new_name_wrapper.innerHTML = '<div class="col-sm-2"><label for="config_new_name">Configuration Name: </label></div>' + 
              '<div class="col-sm-3"><input type="text" class="form-control" id="config_new_name" value="' +
              config_name + '" /></div>';
        }
        else
        {
          config_new_name_wrapper.innerHTML = '';
          if(new_config_process == true)
            new_config_process = false;
        }
      };


      document.addEventListener('DOMContentLoaded', function() {

//~ CONFIGURATION

        document.getElementById('select_config').addEventListener('change', (event) => {
          setCookie('active', document.getElementById('select_config').value, 1);
          location.reload();
        });

        document.getElementById('add_config').addEventListener('click', () => {
          new_config_process = true;
          setParamsActive(true);
          document.getElementById('config_new_name').select();
        });

			  document.getElementById('delete_config').addEventListener('click', (event) => {
          event.preventDefault();
          if (confirm('Are you sure you want to remove this configuration?')) {
            console.log('Thing was saved to the database.');
            fetch('/deleteconfig?config=' + document.getElementById('select_config').value)
            .then((response) => { return response.json() })
            .then((data) => {
              console.log(data);
              location.reload();
            })
            .catch((error) => console.log(error));
          }
        }, false);

        document.getElementById('edit_config_params').addEventListener('click', () => {
          setParamsActive(true, document.getElementById('select_config').value);
        });

        document.getElementById('save_config_params').addEventListener('click', () => {
          let body = getConfigPostParams();
          if(new_config_process)
          {
            let new_name = document.getElementById('config_new_name').value;
            body += '&config_name=' + new_name;
            fetch('/addnewconfig', {
              method: 'POST',
              body: body
            })
            .then((response) => { return response.json() })
            .then((data) => {
              if(data.result == ErrorCodeOk)
              {
                setCookie('active', new_name, 1);
                location.reload();
              }
            })
            .catch((error) => console.log(error));
          }
          else
          {
            let config_name = document.getElementById('select_config').value;
            body += '&config_name=' + config_name;
            let new_name = document.getElementById('config_new_name').value;
            if(config_name != new_name)
            {
              body += '&config_new_name=' + new_name;
            }
            fetch('/saveconfigparams', {
              method: 'POST',
              body: body
            })
            .then((response) => { return response.json() })
            .then((data) => {
              if(config_name != new_name)
              {
                setCookie('active', new_name, 1);
                location.reload();
              }
            })
            .catch((error) => console.log(error));
          }

          setParamsActive(false);
        });

        document.getElementById('cancel_config_params').addEventListener('click', () => {
          setParamsActive(false);
        });

//~ CONFIGURATION

//~ COMMANDS

//~ COMMANDS

      });

    </script>
  </body>
</html>
