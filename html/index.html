<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous"> -->
    <link href="html/bootstrap-5.3.0-dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container py-5">
      <h3 class="h3">Bootstrap v5 Bug Report</h3>

      <div class="row">
        <p>
          <div class="col-sm-2">
            <p>{{header}}</p>
          </div>
          <div class="col-sm-3">
            <select class="form-select" id="select_config" aria-label="Default select example">
              {% for config in configs %}<option value="{{ config }}" {% if config == config_selected %} selected {% endif %} >{{ config }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-sm-4">
            <button type="button" class="btn btn-success" id="add_config">Add configuration</button>
            <button type="button" class="btn btn-success" id="delete_config">Delete configuration</button>
          </div>
        </p>
      </div>

      <div class="row py-2" id="config_new_name_wrapper"></div>

      <div class="row py-2">
        <div class="col-sm-2"><label for="config_speed">Speed</label></div>
        <div class="col-sm-1"><label for="config_databits">Data Bits</label></div>
        <div class="col-sm-1"><label for="config_parity">Parity</label></div>
        <div class="col-sm-1"><label for="config_stopbits">Stop Bits</label></div>
        <div class="col-sm-1"><label for="config_flowcontrol">Flow Ctrl</label></div>
      </div>

      <div class="row">
        <div class="col-sm-2">
          <select class="form-select" id="config_speed" disabled>
            {% for speed in all_port_speed %}<option value="{{ speed }}" {% if speed == port_speed %} selected {% endif %} >{{ speed }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_databits" disabled>
            {% for databits in all_port_databits %}<option value="{{ databits }}" {% if databits == port_databits %} selected {% endif %} >{{ databits }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_parity" disabled>
            {% for parity in all_port_parity %}<option value="{{ parity }}" {% if parity == port_parity %} selected {% endif %} >{{ parity }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_stopbits" disabled>
            {% for stopbits in all_port_stopbits %}<option value="{{ stopbits }}" {% if stopbits == port_stopbits %} selected {% endif %} >{{ stopbits }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-1">
          <select class="form-select" id="config_flowcontrol" disabled>
            {% for flowcontrol in all_port_flowcontrol %}<option value="{{ flowcontrol }}" {% if flowcontrol == port_flowcontrol %} selected {% endif %} >{{ flowcontrol }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-3">
          <button type="button" class="btn btn-success" id="edit_config_params">Edit Config</button>
          <button type="button" class="btn btn-success" id="save_config_params" disabled>Save</button>
          <button type="button" class="btn btn-success" id="cancel_config_params" disabled>Cancel</button>
         </div>
      </div>

      <div class="row py-5">
        <div class="col-sm-2">
          <p>Available Ports:</p>
        </div>
        <div class="col-sm-3">
          <select class="form-select" id="select_ports" aria-label="Default select example">
            {% for port in ports %}<option value="{{ port }}">{{ port }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-sm-5">
          <button type="button" class="btn btn-success" id="port_scan">Rescan Ports</button>
          <button type="button" class="btn btn-primary" id="port_open">Port Open</button>
          <button type="button" class="btn btn-primary" id="port_close" disabled>Port Close</button>
        </div>

        <div class="row py-5">
            {{ commands }}
        </div>

      </div><!-- container -->

      <p>Once you're set, replace the contents of this page and share the link with us in a <a href="#" rel="noopener noreferrer" target="_blank">new issue</a>.</p>
    </div>

    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script> -->
    <script src="html/bootstrap-5.3.0-dist/js/bootstrap.bundle.min.js"></script>
    <script>

      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          let date = new Date();
          date.setTime(date.getTime() + (days*24*60*60*1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
      }

      var params_array = ['config_speed', 'config_databits', 'config_parity', 'config_stopbits', 'config_flowcontrol'];
      var new_config_process = false;

      function setParamsActive(active, config_name = 'NewName') {
        for(param_id of params_array)
          document.getElementById(param_id).disabled = !active;

        document.getElementById('select_config').disabled = active;
        document.getElementById('save_config_params').disabled = !active;
        document.getElementById('cancel_config_params').disabled = !active;

        let config_new_name_wrapper = document.getElementById('config_new_name_wrapper');
        if(active)
        {
          config_new_name_wrapper.innerHTML = '<div class="col-sm-2"><label for="config_new_name">Configuration Name: </label></div>' + 
              '<div class="col-sm-3"><input type="text" class="form-control" id="config_new_name" value="' +
              config_name + '" /></div>';
        }
        else
        {
          config_new_name_wrapper.innerHTML = '';
          if(new_config_process == true)
            new_config_process = false;
        }
      };


      document.addEventListener('DOMContentLoaded', function() {

//~ CONFIGURATION

        document.getElementById('select_config').addEventListener('change', (event) => {
          setCookie('active', document.getElementById('select_config').value, 1);
          location.reload();
        });

        document.getElementById('add_config').addEventListener('click', () => {
          new_config_process = true;
          setParamsActive(true);
        });

			  document.getElementById('delete_config').addEventListener('click', (event) => {
          event.preventDefault();
          if (confirm('Are you sure you want to remove this configuration?')) {
            console.log('Thing was saved to the database.');
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/deleteconfig?config=' + document.getElementById('select_config').value);
            xhr.onload = () => {
              if (xhr.status !== 200) {
                console.log(`Ошибка ${xhr.status}: ${xhr.statusText}`);
                return;
              }
              const response = xhr.response;
              console.log(response);
              location.reload();
            };
            xhr.onerror = () => {
              console.log(`Ошибка при выполнении запроса`);
            };
            xhr.send();
          }
        }, false);

        document.getElementById('edit_config_params').addEventListener('click', () => {
          setParamsActive(true, document.getElementById('select_config').value);
        });

        document.getElementById('save_config_params').addEventListener('click', () => {
          const xhr = new XMLHttpRequest();
          let active_config_name = document.getElementById('select_config').value;
          let body = 'active_config=' + active_config_name + '&';
          let new_name = document.getElementById('config_new_name').value;
          if(active_config_name != new_name)
          {
            body += 'config_new_name=' + document.getElementById('config_new_name').value + '&';
          }
          if(new_config_process == true)
          {
            body += 'new_config_process=true&';
          }
          console.log(body);
          for(param_id of params_array)
          {
            body += param_id + '=' + encodeURIComponent(document.getElementById(param_id).value);
            if(param_id != params_array.slice(-1))
              body += '&';
          }
          xhr.open('POST', '/saveconfigparams');
          xhr.onload = () => {
            if (xhr.status !== 200) {
              console.log(`Ошибка ${xhr.status}: ${xhr.statusText}`);
              return;
            }
            const response = xhr.response;
            console.log(response);
            if(active_config_name != new_name)
            {
              setCookie('active', new_name, 1);
              location.reload();
            }
          };
          xhr.onerror = () => {
            console.log(`Ошибка при выполнении запроса`);
          };
          xhr.send(body);
          setParamsActive(false);
        });

        document.getElementById('cancel_config_params').addEventListener('click', () => {
          setParamsActive(false);
        });

//~ CONFIGURATION

//~ COMMANDS

//~ COMMANDS

      });
    </script>
  </body>
</html>
